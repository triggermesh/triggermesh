version: 2.1

orbs:
  aws-eks: circleci/aws-eks@1
  gcp-cli: circleci/gcp-cli@1
  go: circleci/go@1

jobs:
  checkout-build:
    executor:
      name: go/default
      tag: '1.17'
    steps:
      - checkout
      - go/mod-download-cached
      - restore_cache:
          name: Restoring Go build cache
          # Multi-key caching strategy, as documented at https://circleci.com/docs/2.0/caching/
          # All keys include the 'go.sum' checksum to ensure caches get invalidated
          # when we update either our dependencies or the Go toolchain.
          keys:
              # If a workflow gets retried, the previous run may have already
              # populated the build cache for the current revision.
              # This is the freshest cache we can get.
            - go-build-{{ arch }}-{{ checksum "go.sum" }}-{{ .Revision }}
              # Fall back to the secondary build cache.
              # Although it may not be fresh for the latest code revision, this cache
              # should at least be up-to-date for the current dependencies' versions.
            - go-build-{{ arch }}-{{ checksum "go.sum" }}
      - run:
          name: Populating Go build cache
          command: |
            # Cap parallelism to 1 to prevent maxing out the worker's memory:
            #   /usr/local/go/pkg/tool/linux_amd64/link: signal: killed
            go build -p=1 -v ./cmd/... ./pkg/...
      - save_cache:
          name: Saving primary Go build cache
          key: go-build-{{ arch }}-{{ checksum "go.sum" }}-{{ .Revision }}
          paths:
            - ~/.cache/go-build
      - save_cache:
          name: Saving secondary Go build cache
          key: go-build-{{ arch }}-{{ checksum "go.sum" }}
          paths:
            - ~/.cache/go-build

  test:
    executor:
      name: go/default
      tag: '1.17'
    steps:
      - checkout
      - go/load-cache
      - restore_cache:
          name: Restoring Go build cache
          key: go-build-{{ arch }}-{{ checksum "go.sum" }}-{{ .Revision }}
      - run:
          name: Run test/cover
          command: make cover
          environment:
            TEST_OUTPUT_DIR: /tmp/test-results/
            COVER_OUTPUT_DIR: /tmp/cover-results/
            GOTESTFLAGS: -p=1
      - store_test_results:
          path: /tmp/test-results/
      - store_artifacts:
          path: /tmp/cover-results/

  gen-apidocs:
    executor:
      name: go/default
      tag: '1.17'
    parameters:
      committer_name:
        type: string
        default: TriggerMesh Bot
      committer_email:
        type: string
        default: bot@triggermesh.com
    steps:
      - checkout
      - add_ssh_keys
      - run: ssh-keyscan github.com >> ~/.ssh/known_hosts
      - run:
          name: Configuring git
          command: |
            git config --global user.name '<< parameters.committer_name >>'
            git config --global user.email '<< parameters.committer_email >>'
      - run:
          name: Cloning docs repository
          command: git clone --single-branch git@github.com:triggermesh/docs.git tm-docs
      - run:
          name: Run gen-apidocs
          command:  TRIGGERMESH_COMMIT=${CIRCLE_TAG:-$CIRCLE_SHA1} TRIGGERMESH_OUT_FILE=apis.md make gen-apidocs
          environment:
            DOCS_OUTPUT_DIR: ~/project/tm-docs/docs/apis/
      # - run:
      #     name: Committing triggermesh/docs updates
      #     working_directory: tm-docs/
      #     command: |
      #       if ! git diff --exit-code --quiet; then
      #         git --no-pager diff
      #         git add docs/
      #         git commit -m "Generated with gen-crd-api-reference-docs on git commit ${CIRCLE_TAG:-${CIRCLE_SHA1}}"
      #         git push origin main
      #       fi

  publish-image:
    executor:
      name: gcp-cli/google
    steps:
      - checkout
      - gcp-cli/initialize
      - go/load-cache
      - restore_cache:
          name: Restoring Go build cache
          key: go-build-{{ arch }}-{{ checksum "go.sum" }}-{{ .Revision }}
      - run:
          name: Publishing docker image
          command: IMAGE_SHA=${CIRCLE_SHA1} IMAGE_TAG=${CIRCLE_TAG:-latest} make -j4 cloudbuild
          no_output_timeout: 30m

  deploy:
    description: Patches target cluster configuration
    executor:
      name: go/default
      tag: '1.17'
    parameters:
      cluster:
        type: string
      committer_name:
        type: string
        default: TriggerMesh Bot
      committer_email:
        type: string
        default: bot@triggermesh.com
    steps:
      - checkout
      - add_ssh_keys
      - run: ssh-keyscan github.com >> ~/.ssh/known_hosts
      - run:
          name: Configuring git
          command: |
            git config --global user.name '<< parameters.committer_name >>'
            git config --global user.email '<< parameters.committer_email >>'
      - run:
          name: Cloning config repository
          command: git clone --single-branch git@github.com:triggermesh/config.git tmconfig
      - run:
          name: Updating overlays/<< parameters.cluster >>/triggermesh-core manifests
          working_directory: tmconfig/
          command: |
            IMAGE_REPO=$(sed -n -e 's/^IMAGE_REPO[[:space:]].*=[[:space:]]*\(.*\)$/\1/p' ~/project/Makefile)
            for cmd in ~/project/cmd/*; do
              sed -i overlays/<< parameters.cluster >>/triggermesh-core/deployments.yaml \
                -e "s|gcr.io/triggermesh\(-private\)\?/${cmd##*/}:.*|${IMAGE_REPO}/${cmd##*/}:${CIRCLE_TAG:-${CIRCLE_SHA1}}|g"
            done

            sed -i overlays/<< parameters.cluster >>/triggermesh-core/kustomization.yaml \
              -e "s|github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\(?ref=.*\)\?|github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}?ref=${CIRCLE_TAG:-${CIRCLE_SHA1}}|g"

            git --no-pager diff
      - run:
          name: Committing overlays/<< parameters.cluster >>/triggermesh-core updates
          working_directory: tmconfig/
          command: |
            if ! git diff --exit-code --quiet; then
              git add overlays
              git commit -m "Update overlays/<< parameters.cluster >>/triggermesh-core deployments to '${CIRCLE_TAG:-${CIRCLE_SHA1}}'"
              git push origin main
            fi

  release:
    executor:
      name: go/default
      tag: '1.17'
    steps:
      - checkout
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: $AWS_CLUSTER_NAME
          aws-region: $AWS_REGION
          install-kubectl: true
      - run:
          name: Building release packages
          command: IMAGE_TAG=${CIRCLE_TAG:-latest} make release-yaml
          environment:
            DIST_DIR: /tmp/dist/
      - run:
          name: Installing github-release tool
          command: go install github.com/meterup/github-release@latest
      - run:
          name: Creating github release
          command: |
            PRE_RELEASE=${CIRCLE_TAG/${CIRCLE_TAG%-rc[0-9]*}/}
            github-release delete -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} 2>/dev/null ||:
            ./hack/release-notes.sh ${CIRCLE_TAG} | github-release release ${PRE_RELEASE:+-p} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} -d -
            for f in $(find /tmp/dist -type f); do github-release upload -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} -n $(basename ${f}) -f ${f} ; done

workflows:
  test-and-publish:
    jobs:
      - checkout-build:
          filters:
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
      - test:
          requires:
            - checkout-build
          filters:
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
      - gen-apidocs:
          requires:
            - test
          filters:
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
            branches:
              only: main
      - publish-image:
          context: production
          requires:
            - gen-apidocs
          filters:
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
            branches:
              only: main
      - deploy:
          name: update-staging-config
          cluster: staging
          requires:
            - publish-image
          filters:
            branches:
              only: main
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
      # - deploy:
      #     name: update-production-config
      #     cluster: prod
      #     requires:
      #       - update-staging-config
      #     filters:
      #       tags:
      #         only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
      #       branches:
      #         ignore: /.*/
      - release:
          context: production
          requires:
            - publish-image
          filters:
            tags:
              only: /^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
            branches:
              ignore: /.*/
