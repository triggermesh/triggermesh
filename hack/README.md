# Hack

A directory containing custom scripts and utilities used to help with the day-to-day development of the TriggerMesh
platform.

This practice was inspired by the [Kubernetes project][k8s-hack].

## Contents

- [crd-annotations-check.sh](#crd-annotations-checksh)
- [crd-update.py](#crd-updatepy)
- [gen-api-reference-docs.sh](#gen-api-reference-docssh)
- [inc.Codegen.mk](#inccodegenmk)
- [kodata-check.sh](#kodata-checksh)
- [manifest-cleaner](#manifest-cleaner)
- [rbac-check](#rbac-check)
- [release-notes.sh](#release-notessh)
- [targetgen](#targetgen)

### crd-annotations-check.sh

A shell script which verifies that all TriggerMesh CustomResourceDefinition manifests under [`config/`](../config/) use
a valid JSON-formatted object as the value of the following annotations:

- `registry.knative.dev/eventTypes`
- `registry.triggermesh.io/acceptedEventTypes`

### crd-update.py

A Python script which updates the parts of a given CustomResourceDefinition manifest which are common to all TriggerMesh
CustomResourceDefinitions, such as `spec.adapterOverrides`.

It also indirectly ensures — due to a property of the underlying YAML emitter — that long strings, such as `description`
attributes, are wrapped consistently at 120 characters.

### gen-api-reference-docs.sh

A shell script that generates the HTML version of the [TriggerMesh API reference][tm-apidoc], based on the Go structs
defined in sub-packages of [`pkg/apis/`](../pkg/apis/).

It uses the [`ahmetb/gen-crd-api-reference-docs`][ahmetb-docgen] utility under the hood.

### inc.Codegen.mk

A [Makefile][gnu-make] that contains goals for producing generated code to [`pkg/client/`](../pkg/client/generated/),
such [Kubernetes clients][k8s-codegen] and [Knative injectors][kn-injection].

### kodata-check.sh

A shell script which verifies that all TriggerMesh component commands under [`cmd/`](../cmd/) have a properly set up
`kodata` directory.

Each `kodata` directory typically contains at least (symlinks to) the following files:

- Used by Knative's `logging` package to augment the structured logger with the short hash of the TriggerMesh revision:
  - `.git/refs`: A list of Git references, such as branches and tags, with the hash of their latest commit.
  - `.git/HEAD`: A pointer to the working branch under `.git/refs`.
- Used to reproduce open source licenses in binary distributions of TriggerMesh, such as container images:
  - `LICENSES`: Copies of licenses, copyright notices — and in some cases the source code — of open source software
    dependencies.

### manifest-cleaner

A utility written in Go which cleans up the YAML manifests generated by `ko resolve` by:

- Removing redundant copyright headers
- Filtering out null YAML documents
- Removing `+rbac-check` tags (see description of [rbac-check](#rbac-check))

### rbac-check

A utility written in Go which verifies that all custom types included in the TriggerMesh platform are referenced by the
relevant RBAC roles under [`config/`](../config/).

### release-notes.sh

A shell script that generates release notes in Markdown format for a given revision of TriggerMesh.

### targetgen

A utility written in Go which produces the scaffolding for a new "target" component via code generation.


[k8s-hack]: https://github.com/kubernetes/kubernetes/tree/v1.24.0/hack#readme
[tm-apidoc]: https://docs.triggermesh.io/apis/apis/
[ahmetb-docgen]: https://github.com/ahmetb/gen-crd-api-reference-docs
[gnu-make]: https://www.gnu.org/software/make/
[kn-injection]: https://github.com/knative/pkg/tree/release-1.4/injection#readme
[k8s-codegen]: https://github.com/kubernetes/code-generator/tree/v0.24.0#readme
